<!DOCTYPE HTML>
<html>
<head>
	<!--<link href="./slots_files/slots.css" rel="stylesheet" type="text/css">
	<script src="./slots_files/jquery.1.6.4.min.js" type="text/javascript"></script>
	<script src="./slots_files/jquery.easing.1.3.js" type="text/javascript"></script>-->
<title>Data Visual Tool</title>
<style>
	table{
		border-collapse: collapse;
	}
	tr.border{
		border-top: 1px solid black;
	}

	td{
		padding-right: 21px;
	}

	.bar {
 		 fill: blue;
	}

	.axis text {
 		 font: 20px sans-serif;
	}

	.axis path,
	.axis line {
  		fill: none;
  		stroke: #000;
  		shape-rendering: crispEdges;
  		stroke-width: 3;
	}

	.x.axis path {
  		display: none;
	}

	#pie{
		margin-left: 20%;
	}

	.x-label{
		font: 20px sans-serif;
	}

	.y-label{
		font: 20px sans-serif;	
	}

	#file_output{
		position:absolute;
		padding-top: 831px;
	}
	#graph{
		position: absolute;
	}
	#pie{
		position: absolute;
	}
</style>

</head>
<body>

<div class="container">
	<h3> Data Visualization Tool</h3><p>This web app allows for you to represent data with the four modes shown at the bottom for any structured CSV file.  Make sure the input follows the example:<br>
	<table>
		<tr>
			<td></td>
			<td>Q1</td>
			<td>...</td>
			<td>Qn</td>
		</tr>
		<tr>
			<td>UniqueID</td>
			<td>Major</td>
			<td>...</td>
			<td>DONE</td>
		</tr>
		<tr>
			<td>1</td>
			<td>Economics</td>
			<td>...</td>
		</tr>
		<tr>
			<td>...</td>
			<td>...</td>
			<td>...</td>
		</tr>
	</table>
	<br>Make sure to have "DONE" at the end of the second row to indicate the row dimensions.
	<br>Here is a sample data input file to use: <a href="sample_data_visual.csv" download>Data</a>
	</p>
	<p id="load_done"></p>

	<!--upload csv file-->
	<input id="file_input" type="file" accept=".csv" />
	<input id="file_input2" type="file" accept=".csv" />
	<input id="file_input3" type="file" accept=".txt" />
	<button type="button" id="clear">Unselect all</button>

	<!--select mode of visual representation-->
	<div id="pie"></div>
	<br>
	<div id="graph">
	</div>
	<br>
	<div id="file_output">
		<table>
			<tr id="mode">
				<td><input type="radio" name="graph" value="bar">Bar</td>
				<td><input type="radio" name="graph" value="nest">Nested Bar</td>
				<td><input type="radio" name="graph" value="pie">Pie</td>
				<td><input type="radio" name="graph" value="percent">Percentage</td>
			</tr>
		</table>
		<!--List of all data corresponding to csv file-->
		<table id="filters">
			<!--all filter checkboxes and plottable categories are generated by javascript below-->
		</table>
	</div>

</div>



<script src="components/jquery-1.10.2.js" type="text/javascript"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="d3.pie.min.js"></script>

<script>
	var filter_array;
	var overall_key;
	var pieList = [];

	/*function renderImage4(file) {
		var reader = new FileReader();
	  	reader.onload = function(event) {
	  		var txt = reader.result;
	  		console.log(txt);
 			var param=txt.split(",");
			console.log(param);
			var compil = [];
			var modal = param[0].split(":");
			var plot = param[1].split(":");
			var filters = param[2].split(":");
			var part = filters[0];
			var part2 = filters[1];
			if (compil.indexOf(part)>=0){
				compil[compil.indexOf(part)+1].push(part2);
			}
			else{
				compil.push(part);
				compil.push([part2]);
			}

			if (modal[1] == "pie"){
				
			}
		}
		reader.readAsText(file);
	}*/

	function renderImage3(file) {
		var reader = new FileReader();
	  	reader.onload = function(event) {
	  		var csv = reader.result;
	  		//http://techslides.com/convert-csv-to-json-in-javascript
 			var lines=csv.split("\n");
			var result = [];
			 
			for(var i=0;i<lines.length;i++){	 
				pieList.push(lines[i]);
			}
			console.log(pieList);
		}
		reader.readAsText(file);
	}

	//this function does not do anything; ignore.
	function renderImage2(file) {
		var reader = new FileReader();
	  	reader.onload = function(event) {
	  		var csv = reader.result;
	  		//http://techslides.com/convert-csv-to-json-in-javascript
 			var lines=csv.split("\n");
			var result = [];
			var headers=lines[0].split(",");
			 
			for(var i=1;i<lines.length;i++){	 
				var obj = {};
		        var currentline=lines[i].split(",");
			 
				for(var j=0;j<headers.length;j++){
					obj[headers[j]] = currentline[j];
				}
			 
				result.push(obj);
			}
			var test = JSON.stringify(result);
			json_to_use2 = jQuery.parseJSON(test);
		}
		reader.readAsText(file);
	}

	function key_exists(the_array, the_key){
		for (var index = 0;index<the_array.length;index++){
			if (the_key in the_array[index])
				return index;
		}
		return -1;
	}

	//Method converts csv file into one huge parseable json file.
	//It also generates all the filter checkboxes into the table#filter above.
	//Precondition: @param file must be csv
	//Postcondition: Read description two lines above.
	function renderImage(file) {
		var reader = new FileReader();
	  	reader.onload = function(event) {
	  		var csv = reader.result;
	  		//http://techslides.com/convert-csv-to-json-in-javascript
 			var lines=csv.split("\n");
			var result = [];
			var headers=lines[1].split(",");
			var accum = [];
			var accum_keys = [];
			console.log("key" in {"key":"hello"});
			for(var i=1;i<lines.length;i++){	 
				var obj = {};
		        var currentline=lines[i].split(",");
			 // headers[j].indexOf("Num") >=0 || 
				for(var j=0;j<headers.length;j++){
					if (headers[j].indexOf("Multiple") > 0 && i>1){
						if (currentline[j] != undefined){
							splitted = currentline[j].split("");
							obj[headers[j]] = splitted;
						}
						else{
							obj[headers[j]] = currentline[j];
						}
					}
					else if (!isNaN(headers[j].substring(headers[j].length-1,headers[j].length))){
						if ((((headers[j].substring(0,headers[j].length-1)+"Multiple") in obj)) == false){
							obj[headers[j].substring(0,headers[j].length-1)+"Multiple"] = [currentline[j]];
						}
						else{
							var temp_currentline = obj[headers[j].substring(0,headers[j].length-1)+"Multiple"];
							temp_currentline.push(currentline[j]);
							obj[headers[j].substring(0,headers[j].length-1)+"Multiple"] = temp_currentline;
						}
					}
					else{
						obj[headers[j]] = currentline[j];
					}
					//console.log(obj[headers[j]]);
					if ((headers[j].indexOf("Hours") >=0) && i>1){
						var key_index = key_exists(accum,headers[j]);
						if (key_index >= 0){
							if (parseInt(currentline[j], 10) > parseInt(accum[key_index][headers[j]],10)) {
								accum.splice(key_index,1);
								var temp_obj = {};
								temp_obj[headers[j]] = currentline[j];
								accum.push(temp_obj);
							}
						}
						else{
							var temp_obj = {};
							temp_obj[headers[j]] = currentline[j];
							accum.push(temp_obj);
							accum_keys.push(headers[j]);
						}
					}

				}
				result.push(obj);
			}
			
			console.log(accum);

		    var test = JSON.stringify(result);
			json_to_use = jQuery.parseJSON(test);
			//json_to_use[1].Residence = "yellow";
			console.log(json_to_use);
			console.log(json_to_use[1].Major1);

			json_to_use.forEach(function(sub_info){
				for (var a =0;a<accum_keys.length;a++){
					var val = parseInt(sub_info[accum_keys[a]],10);
					var bins = [];
					var divide = parseInt(accum[a][accum_keys[a]],10)/5;
					var temp_divide = 1;
					bins.push(0);
					while (temp_divide < accum[a][accum_keys[a]]){
						bins.push(temp_divide+divide);
						temp_divide+=divide;
					}
					if (val == 0)
						sub_info[accum_keys[a]] = 0;
					else{
						for (var b=1;b<bins.length;b++){
							if (val <= bins[b] && val > bins[b-1])
								sub_info[accum_keys[a]] = "" + bins[b-1] + "-" + bins[b];
						}
					}
				}

			});
			/*accum.forEach(function(sub_accum){
				$.each(sub_accum, function(key,value) {
					var bins = [];
					var divide = value/5;
					var temp_divide = 1;
					bins.push(0);
					while (temp_divide < value){
						bins.push(temp_divide+divide);
					}
					for (var accum_index2=0;accum_index2<json_to_use.length;accum_index2++){
						if (parseInt(json_to_use[accum_index2][key]) == 0){
							json_to_use[accum_index2].key = 0;
						}
						for (var indi = 1; indi<bins.length;indi++){
							if (parseInt(json_to_use[accum_index2][key])<=bins[indi] && parseInt(json_to_use[accum_index2][key])>bins[indi-1]){
								json_to_use[accum_index2].key = indi;
							}
						}
					}
				});	
			});*/
			
  
			json_to_use.forEach(function(info) {


			  	/*if (c.indexOf(info.Time) < 0 && info.Time != "Time" && info.Time != undefined){
			  		time.push(info.Time);
			  	}*/
			  	$.each(info, function(key,value) {
			  		/*if (key.indexOf("Hours") >=0){

			  		}*/
			  		
				  		if ($("tr#"+key).length==0 && key != "Done" && key!="Done\r" && key!="DoneMultiple"){
				  			$("table#filters").append("<tr class='border' id='"+key+"'><td>"+key+"</td><td><input type='checkbox' name='all_"+key+"' value='all_"+key+"'>PLOT</td></tr>");
				  		}
				  		else if ($("tr#"+key).length>0){
				  			var children = $("tr#"+key).children();
				  			var exists = false;
				  			var exists_multiple = [];
				  			for (var ind=0;ind<children.length;ind++){
				  				if ($(children[ind]).children().length > 0){
									if (($(children[ind]).children())[0].tagName=="INPUT"){
										if (value.constructor === Array){
			  								if (value.indexOf($(($(children[ind]).children())[0]).attr("value")) >=0){
			  									exists_multiple.push($(($(children[ind]).children())[0]).attr("value"));
			  								}
									  	}
										else if ($(($(children[ind]).children())[0]).attr("value")==value){
											exists = true;
										}
									}
								}
				  			}
				  			
				  			if ((!exists && value != "") || value.constructor === Array){
				  				//if (!isNaN(key.substring(key.length-1,key.length))){}
				  				if (value.constructor === Array){
				  					for (var val_index = 0; val_index < value.length; val_index++){
				  						//console.log(value[val_index]);
				  						if (exists_multiple.indexOf(value[val_index]) < 0 && value[val_index] != "")
				  							$("tr#"+key).append("<td class='sorted_"+key+"'><input type='checkbox' name='"+key+"' value='"+value[val_index]+"'>"+value[val_index]+"</td>");
				  					}
				  				}
				  				else{
				  					$("tr#"+key).append("<td class='sorted_"+key+"'><input type='checkbox' name='"+key+"' value='"+value+"'>"+value+"</td>");
				  				}
				  				var to_be_sorted = document.getElementsByClassName("sorted_"+key);
				  				//console.log(to_be_sorted);

				  				//stackoverflow
								to_be_sorted = Array.prototype.slice.call(to_be_sorted).sort(function(a, b) {
    									//console.log(a.firstChild.getAttribute("value"));
    									//console.log(b.children().attr("value"));
    									if (parseInt(a.firstChild.getAttribute("value"),10) == 0 && a.firstChild.getAttribute("value").length == 1)
    										return -1;
    									else if (parseInt(b.firstChild.getAttribute("value"),10) == 0  && b.firstChild.getAttribute("value").length == 1)
    										return 1;
    									if (parseInt(a.firstChild.getAttribute("value"),10) >= 0){
    										if (parseInt(a.firstChild.getAttribute("value"),10) > parseInt(b.firstChild.getAttribute("value"),10))
    											return 1;
    										else if	(parseInt(a.firstChild.getAttribute("value"),10) < parseInt(b.firstChild.getAttribute("value"),10))
    											return -1;
    										else
    											return 0;
    									}
    									else
    										return a.firstChild.getAttribute("value").localeCompare(b.firstChild.getAttribute("value"));
									});

								for (var i = 0; i < to_be_sorted.length; i++) {
    								$("tr#"+key).append(to_be_sorted[i]);
								}
				  			}
				  		}
				  	
			  	});
			});
		}
		reader.readAsText(file);
	}

	function create_pie(pieList, json_to_use, compil){
		var pie;
		console.log(compil);
		if ($("svg").length){
			$("svg").remove();
		}
		if ($("#error").length){
			$("#error").remove();
		}

		//fix so doesn't use default value in filters applied 
		//how saturated are the majors/residences.  Clicks pie, with all majors and residences lists, go through the list, check is there a Christian in the major/residence
		//does this major/residence have "A" Christian.  If yes, go into yes Christian in pie chart.
		//major/residence with Christians filters applied (if filters applied), major/residence with Christians that don't satisfy the filters, and majors/residences without any Christians.
		//apply the Church or Felly, then branch into the four bins.
		//Case 2:  If one church or one fellowship is selected.  4 bins: (1) non-Christians, (2) Christians not in selected church or fellowship but in filtered set, (3) Christians in selected church or fellowship but not in the rest of the filtered set, and (4) Christians in the selected church or fellowship and in the rest of the filtered set.

		//click pie, automatically click PLOT for Christians
		//export to powerpoint
		//command on browser
		//import scripting file ->plot, filters, export command

		//develop test cases in the Excel sheet, make sure the program agrees with the numbers.

		var christians = 0;
		var non_christians = 0;
		var christians_just_filter = [];
		var christians_just_in_group = [];
		var christians_all_filter = 0;
		var christians_total_filters = 0;

		//investigate order of Felly and filters applied (order makes output different)

		for (var list_index=0;list_index<pieList.length;list_index++){
			console.log(pieList[list_index]);
			var stop = false;
			var stop2 = false;
			var stop3 = false;
			//investigate why length - 1
			for (var list_index2=1;list_index2<json_to_use.length-1;list_index2++){
				pie_info = json_to_use[list_index2];
				major1 = pie_info.MajorMultiple;
				console.log(major1.indexOf(pieList[list_index].substring(0,pieList[list_index].length-1)));
				res = pie_info.Residence;
				felly1 = pie_info.FellyMultiple;
				church1 = pie_info.ChurchMultiple;
				if ((major1.indexOf(pieList[list_index].substring(0,pieList[list_index].length-1)) >= 0 || pieList[list_index] == res+"\r") && ((compil.indexOf("ChurchMultiple") >= 0 && compil.indexOf("FellyMultiple") < 0) || (compil.indexOf("ChurchMultiple") < 0 && compil.indexOf("FellyMultiple") >= 0))) {
					//console.log(pie_info.Major1);
					var temp_track2 = 0;
					var nevermind = 0;
					var all_true_none2 = 1;
					console.log(compil);
					if (compil.length > 2){
						for (var list_index3=0;list_index3<compil.length;list_index3+=2){
							var temp_compil = compil[list_index3+1];
							for (var list_index4=0;list_index4<temp_compil.length;list_index4++){
								
								if (pie_info[compil[list_index3]].constructor === Array){
									if (pie_info[compil[list_index3]].indexOf(temp_compil[list_index4]) >= 0) {
										if (compil.indexOf("FellyMultiple") >=0){
											if(felly1.indexOf(compil[compil.indexOf("FellyMultiple")+1][0]) >= 0){
												temp_track2++;
											}
											
										}
										else if (compil.indexOf("ChurchMultiple") >=0){
											if(church1.indexOf(compil[compil.indexOf("ChurchMultiple")+1][0]) >= 0){
												temp_track2++;
											}

										}
									}
								}
								else{
									if (pie_info[compil[list_index3]] == temp_compil[list_index4]) {
										if (compil.indexOf("FellyMultiple") >=0){
											if(felly1.indexOf(compil[compil.indexOf("FellyMultiple")+1][0]) >= 0){
												temp_track2++;
											}
											
										}
										else if (compil.indexOf("ChurchMultiple") >=0){
											if(church1.indexOf(compil[compil.indexOf("ChurchMultiple")+1][0]) >= 0){
												temp_track2++;
											}

										}
									}
								}
							}
						}
						if ((temp_track2 == (compil.length/2)-1)) {
							if (christians_just_filter.indexOf(pieList[list_index]) < 0){
								christians_just_filter.push(pieList[list_index]);
							}
						}
					}
					else{
						if (compil.indexOf("FellyMultiple") >=0){
							if(felly1.indexOf(compil[1][0]) >= 0){
								if (christians_just_filter.indexOf(pieList[list_index]) < 0){
									christians_just_filter.push(pieList[list_index]);
									christians_just_filter.push("temp");
								}
							}
							else{
								if (christians_just_filter.indexOf(pieList[list_index]) >= 0){
									var index_filter = christians_just_filter.indexOf(pieList[list_index]);
									christians_just_filter[index_filter+1] = "final";
								}
								else{
									christians_just_filter.push(pieList[list_index]);
									christians_just_filter.push("final");	
								}
							}
						}
						else if (compil.indexOf("ChurchMultiple") >=0){
							if(church1.indexOf(compil[1][0])>=0){
								if (christians_just_filter.indexOf(pieList[list_index]) < 0){
									christians_just_filter.push(pieList[list_index]);
									christians_just_filter.push("temp");
								}
							}
							else{
								if (christians_just_filter.indexOf(pieList[list_index]) >= 0){
									var index_filter = christians_just_filter.indexOf(pieList[list_index]);
									christians_just_filter[index_filter+1] = "final";
								}
								else{
									christians_just_filter.push(pieList[list_index]);
									christians_just_filter.push("final");	
								}	
							}
						}	
					}

					if (compil.indexOf("FellyMultiple") >=0){
							if(felly1.indexOf(compil[compil.indexOf("FellyMultiple")+1][0]) >= 0){
								if (christians_just_in_group.indexOf(pieList[list_index]) < 0){
									christians_just_in_group.push(pieList[list_index]);
									christians_just_in_group.push("temp");
								}
							}
							else{
								if (christians_just_in_group.indexOf(pieList[list_index]) >= 0){
									var index_filter = christians_just_in_group.indexOf(pieList[list_index]);
									christians_just_in_group[index_filter+1] = "final";
								}
								else{
									christians_just_in_group.push(pieList[list_index]);
									christians_just_in_group.push("final");	
								}
							}
						}
						else if (compil.indexOf("ChurchMultiple") >=0){
							if(church1.indexOf(compil[compil.indexOf("ChurchMultiple")+1][0]) >= 0){
								if (christians_just_in_group.indexOf(pieList[list_index]) < 0){
									christians_just_in_group.push(pieList[list_index]);
									christians_just_in_group.push("temp");
								}
							}
							else{
								if (christians_just_in_group.indexOf(pieList[list_index]) >= 0){
									var index_filter = christians_just_in_group.indexOf(pieList[list_index]);
									christians_just_in_group[index_filter+1] = "final";
								}
								else{
									christians_just_in_group.push(pieList[list_index]);
									christians_just_in_group.push("final");	
								}	
							}
						}
				}
				if ((pie_info.MajorMultiple.indexOf(pieList[list_index].substring(0,pieList[list_index].length-1)) >= 0 || pieList[list_index] == pie_info.Residence+"\r") && pie_info.Christian == "1" && stop == false){
					christians++;
					stop = true;
				}
				if ((pie_info.MajorMultiple.indexOf(pieList[list_index].substring(0,pieList[list_index].length-1)) >= 0 || pieList[list_index] == pie_info.Residence+"\r") && compil.indexOf("ChurchMultiple") < 0 && compil.indexOf("FellyMultiple") < 0 && stop2 == false && compil.length > 0){
					var temp_track = 0;
					var all_true_none = 1;
					for (var list_index3=0;list_index3<compil.length;list_index3+=2){
						var temp_compil = compil[list_index3+1];
						for (var list_index4=0;list_index4<temp_compil.length;list_index4++){

							if (pie_info[compil[list_index3]].constructor === Array){
								if (pie_info[compil[list_index3]].indexOf(temp_compil[list_index4]) >= 0) {
									temp_track++;
								}
							}
							else{
								if (pie_info[compil[list_index3]] == temp_compil[list_index4]) {
									temp_track++;
								}
							}
							
						}
					}
					if (temp_track == compil.length/2){
						christians_all_filter++;
						stop2 = true;
					}	
				}

				else if ((pie_info.MajorMultiple.indexOf(pieList[list_index].substring(0,pieList[list_index].length-1)) >= 0 || pieList[list_index] == pie_info.Residence+"\r") && ((compil.indexOf("ChurchMultiple") >= 0 && compil.indexOf("FellyMultiple") < 0) || (compil.indexOf("ChurchMultiple") < 0 && compil.indexOf("FellyMultiple") >= 0)) && stop2 == false){
					var temp_track3 = 0;
					var all_true_none3 = 1;
					for (var list_index3=0;list_index3<compil.length;list_index3+=2){
						var temp_compil = compil[list_index3+1];
						for (var list_index4=0;list_index4<temp_compil.length;list_index4++){

							if (pie_info[compil[list_index3]].constructor === Array){
								if (pie_info[compil[list_index3]].indexOf(temp_compil[list_index4]) >= 0) {
									temp_track3++;
								}
							}
							else{
								if (pie_info[compil[list_index3]] == temp_compil[list_index4]) {
									temp_track3++;
								}
							}
						}
					}
					if (temp_track3 == compil.length/2){
						christians_total_filters++;
						stop2 = true;
					}
				}
			}
			if (stop==false){
				non_christians++;
			}
		}
		console.log(christians);
		console.log(non_christians);
		if (compil.indexOf("ChurchMultiple") < 0 && compil.indexOf("FellyMultiple") < 0){

			console.log(christians_all_filter);
			//code should combine Felly1, Felly2, Felly 3 all into one.
			//input code and output whatever you need (one of the commands needs to be print powerpoint)
			pie = new d3pie("pie", {
					header: {
						title: {
							text: "Pie Chart of Christians and Non-Christians"
						}
					},
					data: {
						content: [
							{ label: "Non-Christians", value: non_christians },
							{ label: "Christians", value: christians},
							{ label: "Christians, filters applied", value: christians_all_filter},
						]
					},

					misc: {
						pieCenterOffset: {
							x: 50,
							y: 10
						}
					},

					size: {
						canvasHeight: 700,
						canvasWidth: 700
					}
			});
		}
		if ((compil.indexOf("ChurchMultiple") >= 0 && compil[compil.indexOf("ChurchMultiple")+1].length > 1) || (compil.indexOf("FellyMultiple") >= 0 && compil[compil.indexOf("FellyMultiple")+1].length > 1) || (compil.indexOf("ChurchMultiple") >= 0 && compil.indexOf("FellyMultiple") >= 0)){
			$("#pie").append("<p id='error'>ERROR: cannot pick more than one Church or Fellowship or both</p>");
		}

		else if ((compil.indexOf("ChurchMultiple") >= 0 && compil.indexOf("FellyMultiple") < 0) || (compil.indexOf("ChurchMultiple") < 0 && compil.indexOf("FellyMultiple") >= 0)) {

			/*for (var list_index3=0;list_index3<compil.length;list_index3+=2){
				var all_true = 1;
				var temp_compil = compil[list_index3+1];
				if (compil[list_index3] == "Felly1" || compil[list_index3] == "Church1"){
					for (var list_index4=0;list_index4<temp_compil.length;list_index4++){
						if (pie_info[compil[list_index3]] != temp_compil[list_index4]){
							all_true = 0;
						}
					}
				}
			}*/
			console.log(christians_just_in_group);
			console.log(christians_all_filter);
			console.log(christians_total_filters);
			just_filter = 0;
			just_in_group = 0;
			if (christians_just_filter.indexOf("temp") >=0 || christians_just_filter.indexOf("final") >=0){
				for (var just_filter_index=1; just_filter_index < christians_just_filter.length;just_filter_index+=2){
					if (christians_just_filter[just_filter_index] == "temp"){
						just_filter++;
					}
				}
			}
			else{
				just_filter = christians_just_filter.length;
			}
			for (var just_group_index=1;just_group_index<christians_just_in_group.length;just_group_index+=2){
				if (christians_just_in_group[just_group_index] == "final"){
						just_in_group++;
					}
			}
			console.log(just_in_group);
			console.log(just_filter);
			console.log(christians_just_in_group.length);
			if (compil.length==2 && (compil[0]=="FellyMultiple" || compil[0]=="ChurchMultiple")){
				pie = new d3pie("pie", {
					header: {
						title: {
							text: "Pie Chart of Christians and Non-Christians"
						}
					},
					data: {
						content: [
							{ label: "Non-Christians", value: non_christians },
							{ label: "Christians in Church/Felly", value: just_in_group},
							{ label: "Christians not in Church/Felly", value: christians-christians_total_filters},
						]
					},

					misc: {
						pieCenterOffset: {
							x: 50,
							y: 10
						}
					},

					size: {
						canvasHeight: 1000,
						canvasWidth: 1000
					}
				});
			}
			else{
				pie = new d3pie("pie", {
					header: {
						title: {
							text: "Pie Chart of Christians and Non-Christians"
						}
					},
					data: {
						content: [
							{ label: "Non-Christians", value: non_christians },
							{ label: "Christians not in Church/Felly", value: (christians_just_in_group.length/2)-just_in_group},
							{ label: "Christians in Church/Felly, no filters", value: just_in_group-christians_total_filters},
							{ label: "Christians in Church/Felly, filters applied", value: christians_total_filters},
						]
					},

					misc: {
						pieCenterOffset: {
							x: 50,
							y: 10
						}
					},

					size: {
						canvasHeight: 1000,
						canvasWidth: 1000
					}
				});
			}
		}
	}
	


	//Meat of the webapp.  Depending on what user clicks, filters get applied and graphs get plot.  Comments are provided where important steps are below.
	$("document").ready(function(){
		//generate bar graph on combinatorial combinations of filter checkboxes chosen
		/*var children = $("tr#EveryWeeker").children();
		console.log(children);
		var exists = false;
		for (var ind=0;ind<children.length;ind++){
			if ($(children[ind]).children().length > 0){
				if (($(children[ind]).children())[0].tagName=="INPUT")
					console.log($(($(children[ind]).children())[0]).attr("value"));
			}
		}*/
		$("#load_done").html("Page is done loading.  Please use it!");
		var mode;
		var filter="";
		var filter_array2=[];
		var compil = [];
		var bar_data_final2 = [];
		var extra_tag = [];
		var totality = [];
		var tally = [];

		//Unselects all checkboxes, BUT NOT THE RADIO BUTTON FOR GRAPH MODE
		$("#clear").click(function() {
			$('input:checkbox').each(function() {
       			$(this).prop("checked", false);
  			});
  			if ($("svg").length){
				$("svg").remove();
			}
			filter="";
			filter_array2=[];
			compil = [];
			bar_data_final2 = [];
			extra_tag = [];
			totality = [];
			tally = [];
		});

		console.log("YO");
		$("#file_input").change(function() {
		    // grab the first image in the FileList object and pass it to the function
		    renderImage(this.files[0]);
		});

		$("#file_input2").change(function() {
		    // grab the first image in the FileList object and pass it to the function
		    renderImage3(this.files[0]);
		});

		$("#file_input3").change(function() {
		    // grab the first image in the FileList object and pass it to the function
		    renderImage4(this.files[0]);
		});



		//mode changes depending on what kind of graph user desires.
		$(document).on("click","input", function() {
			if ($(this).attr('type') == 'radio'){
				if ($(this).attr('value') == "bar"){
					mode="bar";
					console.log("THIS");
				}
				else if($(this).attr('value') == "nest"){
					mode="nest";
				}
				else if ($(this).attr('value') == "pie"){
					mode="pie";
					console.log('hello');
					$('input[name="all_Christian"]').prop('checked', true);
					if (($('input[name="all_Christian"]').attr('name')+"").substring(0,3)=="all"){
						if ($('input[name="all_Christian"]').is(":checked")){
							filter = ($('input[name="all_Christian"]').attr('name')+"").substring(4,($('input[name="all_Christian"]').attr('name')+"").length);
							console.log(filter);
							var fil = $("tr#"+filter).children();
							console.log(fil);
							for (var i=2;i<fil.length;i++){
								if (fil[i].outerText != "")
									filter_array2.push(fil[i].outerText);
							}
							console.log(filter_array2);

							for (var t=0;t<filter_array2.length;t++){
								var count = 0;
								json_to_use.forEach(function(info) {
						  			$.each(info, function(key,value) {
						  				if (key==filter){
						  					if (value.constructor === Array){
						  						if (value.indexOf(filter_array2[t]) >= 0){
						  							count++;
						  						}
						  					}
						  					else if (value==filter_array2[t])
						  						count++;
						  				}
						  			});
						  		});
						  		tally.push(count);
							}

							for (var t3=0;t3<tally.length;t3++){
								bar_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
								totality.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
							}
						//set x-axis as the answers to the name chosen -> no fixed variables, just search through children to get the answers.
						//make key value map in an array to store answers in correct places, and cross reference while searching through json_to_use, while keeping track of counter for each answer for x-axis.
						}
						else{
							if ($("svg").length){
								$("svg").remove();
							}
							filter="";
							filter_array2=[];
							compil = [];
							bar_data_final2 = [];
							extra_tag = [];
							totality = [];
							tally = [];
						}
					}

					else if (filter!=""){
						console.log("HERE");
						bar_data_final2 = [];
						pie_data_final = [];
						pie_data_final2 = [];
						extra_tag = [];
						var part = $(this).attr('name') + "";
						var part2 = $(this).attr('value') + "";
						//figure out neat data structure to store these (should not create new if part already exists in array)
						if ($(this).is(":checked")){
							if (compil.indexOf(part)>=0){
								compil[compil.indexOf(part)+1].push(part2);
							}
							else{
								compil.push(part);
								compil.push([part2]);
							}
						}
						else{
							if (compil.indexOf(part) >=0){
								console.log("CORRECT");
								compil[compil.indexOf(part)+1].splice(compil[compil.indexOf(part)+1].indexOf(part2),1);
								//console.log(compil);
								if (compil[compil.indexOf(part)+1].length == 0){
									compil.splice(compil.indexOf(part)+1,1);
									compil.splice(compil.indexOf(part),1);
								}
							}
						}

						console.log(compil);
						if (compil.length > 0){
							for (var t2=0;t2<filter_array2.length;t2++){
								var count2 = 0;
								var count4 = 0;
								var count6 = 0;
								json_to_use.forEach(function(info) {
									var all_holds = [];
									var all_holds_pie = [];
									var all_holds_pie2 = [];
									if (info[filter] == filter_array2[t2]){
							  			for (var t4=0;t4<compil.length;t4+=2){
							  				//AND and or with compil
							  				var temp_array = compil[t4+1];
							  				for (var t6=0;t6<temp_array.length;t6++){
							  					if (info[compil[t4]] == temp_array[t6]){
							  						all_holds.push(1);
							  					}
							  					if (compil[t4] != "Felly1" && compil[t4] != "Church1" && info[compil[t4]] == temp_array[t6]){
							  						all_holds_pie.push(1);
							  					}
							  					if ((compil[t4] == "Felly1" || compil[t4] == "Church1") && info[compil[t4]] == temp_array[t6]){
							  						all_holds_pie2.push(1);
							  					}

							  				}
							  				if (all_holds.length == (compil.length/2)){
							  					count2++;
							  				}

							  				if (all_holds_pie.length == (compil.length/2) - 1){
							  					count4++;
							  				}
							  				if (all_holds_pie2.length == 1){
							  					count6++;
							  				}
							  			}


							  			console.log(all_holds.length);
							  			
							  		}
							  		
							  		/*$.each(info, function(key,value) {
							  			if (key==filter && filter_array2[t2]==value){
							  				var all_holds = true;
							  				for (var t4=0;t4<)
							  			}
							  		});*/
							  	});
							  	console.log(count2);
								bar_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t2]+'","count":'+count2+'}'));
								pie_data_final.push(jQuery.parseJSON('{"filter":"'+filter_array2[t2]+'","count":'+count4+'}'));
								pie_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t2]+'","count":'+count6+'}'));
								extra_tag.push(count2);
								console.log(pie_data_final);
								console.log(pie_data_final2);
							}
						}
						else{
							console.log(filter);
							console.log(filter_array2);
							tally = [];
							for (var t=0;t<filter_array2.length;t++){
								var count = 0;
								json_to_use.forEach(function(info) {
					  				$.each(info, function(key,value) {
					  					if (key==filter){
						  					if (value.constructor === Array){
						  						if (value.indexOf(filter_array2[t]) >= 0){
						  							count++;
						  						}
						  					}
						  					else if (value==filter_array2[t])
						  						count++;
						  				}
					  				});
					  			});
					  			tally.push(count);
							}

							for (var t3=0;t3<tally.length;t3++){
								bar_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
								totality.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
							}
						}
					}
				}
				else
					mode="percent";
			}
			
			//If user clicks a checkbox, check if it was PLOT button or one of the individual answer choices.
			//If PLOT was selected, var filter gets set to that, and initial graph gets plotted with just that information.
			//If filter(s) are checked, graph of original PLOT question is graphed along with chosen filters.
			//PROCESS OF GRAPHING: go through the json array and through each json object, if all filters correspond to the answers in each object, count goes up.  Total count for each PLOT answer choices should be reflected in the graph.

			//Revise all filter and compil to fit accumulated majors, fellies, whyfollow.
			else if ($(this).attr('type') == 'checkbox'){
				if (($(this).attr('name')+"").substring(0,3)=="all"){
					if ($(this).is(":checked")){
						filter = ($(this).attr('name')+"").substring(4,($(this).attr('name')+"").length);
						console.log(filter);
						var fil = $("tr#"+filter).children();
						console.log(fil);
						for (var i=2;i<fil.length;i++){
							if (fil[i].outerText != "")
								filter_array2.push(fil[i].outerText);
						}
						console.log(filter_array2);

						for (var t=0;t<filter_array2.length;t++){
							var count = 0;
							json_to_use.forEach(function(info) {
					  			$.each(info, function(key,value) {
					  				if (key==filter){
					  					if (value.constructor === Array){
					  						if (value.indexOf(filter_array2[t]) >= 0){
					  							count++;
					  						}
					  					}
					  					else if (value==filter_array2[t])
					  						count++;
					  				}
					  			});
					  		});
					  		tally.push(count);
						}

						for (var t3=0;t3<tally.length;t3++){
							bar_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
							totality.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
						}
					//set x-axis as the answers to the name chosen -> no fixed variables, just search through children to get the answers.
					//make key value map in an array to store answers in correct places, and cross reference while searching through json_to_use, while keeping track of counter for each answer for x-axis.
					}
					else{
						if ($("svg").length){
							$("svg").remove();
						}
						filter="";
						filter_array2=[];
						compil = [];
						bar_data_final2 = [];
						extra_tag = [];
						totality = [];
						tally = [];
					}
				}

				else if (filter!=""){
					console.log("HERE");
					bar_data_final2 = [];
					pie_data_final = [];
					pie_data_final2 = [];
					extra_tag = [];
					var part = $(this).attr('name') + "";
					var part2 = $(this).attr('value') + "";
					//figure out neat data structure to store these (should not create new if part already exists in array)
					if ($(this).is(":checked")){
						if (compil.indexOf(part)>=0){
							compil[compil.indexOf(part)+1].push(part2);
						}
						else{
							compil.push(part);
							compil.push([part2]);
						}
					}
					else{
						if (compil.indexOf(part) >=0){
							console.log("CORRECT");
							compil[compil.indexOf(part)+1].splice(compil[compil.indexOf(part)+1].indexOf(part2),1);
							//console.log(compil);
							if (compil[compil.indexOf(part)+1].length == 0){
								compil.splice(compil.indexOf(part)+1,1);
								compil.splice(compil.indexOf(part),1);
							}
						}
					}

					console.log(compil);
					if (compil.length > 0){
						for (var t2=0;t2<filter_array2.length;t2++){
							var count2 = 0;
							var count4 = 0;
							var count6 = 0;
							json_to_use.forEach(function(info) {
								var all_holds = [];
								var all_holds_pie = [];
								var all_holds_pie2 = [];
								if (info[filter] == filter_array2[t2]){
						  			for (var t4=0;t4<compil.length;t4+=2){
						  				//AND and or with compil
						  				var temp_array = compil[t4+1];
						  				for (var t6=0;t6<temp_array.length;t6++){
						  					console.log(info[compil[t4]]);
						  					console.log(temp_array[t6]);
						  					if (compil[t4].indexOf("Multiple") >= 0){
						  						if (info[compil[t4]].indexOf(temp_array[t6]) >= 0){
						  							all_holds.push(1);
						  						}
						  					}
						  					else if (info[compil[t4]] == temp_array[t6]){
						  						all_holds.push(1);
						  					}

						  					if (compil[t4] != "Felly1" && compil[t4] != "Church1" && info[compil[t4]] == temp_array[t6]){
						  						all_holds_pie.push(1);
						  					}
						  					if ((compil[t4] == "Felly1" || compil[t4] == "Church1") && info[compil[t4]] == temp_array[t6]){
						  						all_holds_pie2.push(1);
						  					}

						  				}
						  				if (all_holds.length == (compil.length/2)){
						  					count2++;
						  				}

						  				if (all_holds_pie.length == (compil.length/2) - 1){
						  					count4++;
						  				}
						  				if (all_holds_pie2.length == 1){
						  					count6++;
						  				}
						  			}
						  			
						  		}
						  		
						  		/*$.each(info, function(key,value) {
						  			if (key==filter && filter_array2[t2]==value){
						  				var all_holds = true;
						  				for (var t4=0;t4<)
						  			}
						  		});*/
						  	});
							bar_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t2]+'","count":'+count2+'}'));
							pie_data_final.push(jQuery.parseJSON('{"filter":"'+filter_array2[t2]+'","count":'+count4+'}'));
							pie_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t2]+'","count":'+count6+'}'));
							extra_tag.push(count2);
						}
					}
					else{
						console.log(filter);
						console.log(filter_array2);
						tally = [];
						for (var t=0;t<filter_array2.length;t++){
							var count = 0;
							json_to_use.forEach(function(info) {
				  				$.each(info, function(key,value) {
				  					if (key==filter){
					  					if (value.constructor === Array){
					  						if (value.indexOf(filter_array2[t]) >= 0){
					  							count++;
					  						}
					  					}
					  					else if (value==filter_array2[t])
					  						count++;
					  				}
				  				});
				  			});
				  			tally.push(count);
						}

						for (var t3=0;t3<tally.length;t3++){
							bar_data_final2.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
							totality.push(jQuery.parseJSON('{"filter":"'+filter_array2[t3]+'","count":'+tally[t3]+'}'));
						}
					}
				}
			}

			//Different graph is plotted depending on what mode is set by user
			//PIE CHART
			if (mode=="pie" && filter != ""){
				create_pie(pieList, json_to_use, compil);
			}
			
			if (mode=="bar" && filter!=""){
				console.log(bar_data_final2);
				console.log(totality);
				var margin = {top: 20, right: 30, bottom: 30, left: 40},
			    width = 800 - margin.left - margin.right,
			    height = 700 - margin.top - margin.bottom;
				var x = d3.scale.ordinal().domain(filter_array2).rangeRoundBands([0, width], .1);

				var y = d3.scale.linear().domain([0, d3.max(bar_data_final2, function(d) { return d.count; })]).range([height, 0]);

				var xAxis = d3.svg.axis().scale(x).orient("bottom");

				//var yAxis = d3.svg.axis().scale(y).orient("left").ticks(d3.max(bar_data_final2, function(d) { return d.count; })/5);
				var yAxis = d3.svg.axis().scale(y).orient("left");

				if ($("svg").length){
					$("svg").remove();
				}
				var chart = d3.select("#graph").append("svg").attr("width", width + margin.left + margin.right + 100).attr("height", height + margin.top + margin.bottom + 100).append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			  	chart.append("g").attr("class", "x axis").attr("transform", "translate(50," + height + ")").call(xAxis);

			 	chart.append("g").attr("class", "y axis").attr("transform","translate(50,0)").call(yAxis);

			  	chart.selectAll(".bar").data(bar_data_final2).enter().append("rect").attr("class", "bar").attr("x", function(d) { return x(d.filter) + 50; }).attr("y", function(d) { return y(d.count); }).attr("height", function(d) {return height - y(d.count); }).attr("width", x.rangeBand());

			  	chart.append("text")
					.attr("class", "x-label")
					.attr("text-anchor", "end")
					.attr("x", width-250)
					.attr("y", height + 60)
					.text("Survey Responses");

				chart.append("text")
					.attr("class", "y-label")
					.attr("text-anchor", "end")
					.attr("x", -270)
					.attr("y",-16)
					.attr("transform", "rotate(-90)")
					.text("Number of Students");

				function type(d) {
			  		d.count = +d.count; // coerce to number
			  		return d;
				}
			}

			//NESTED BAR GRAPH
			if (mode=="nest" && filter!=""){
				var n = filter_array2.length, // number of samples
			    m = 2; // number of series
			    var final_nest_array = [tally,extra_tag];

				var margin = {top: 20, right: 30, bottom: 30, left: 40},
			    width = 1000 - margin.left - margin.right,
			    height = 700 - margin.top - margin.bottom;

				var y = d3.scale.linear()
			    	.domain([0, d3.max(tally,function(d) { return d;})])
			    	.range([height,0]);

				var x0 = d3.scale.ordinal()
			    	.domain(d3.range(n))
			    	.rangeBands([0, width], .2);

				var x1 = d3.scale.ordinal()
			    	.domain(d3.range(m))
			    	.rangeBands([0, x0.rangeBand()]);

			    var x2 = d3.scale.ordinal().domain(filter_array2).rangeRoundBands([0, width], .1);

				var z = d3.scale.category10();

				var xAxis = d3.svg.axis()
			    	.scale(x2)
			    	.orient("bottom");

				var yAxis = d3.svg.axis()
			    	.scale(y)
			    	.orient("left");

			    if ($("svg").length){
					$("svg").remove();
				}

				var svg = d3.select("#graph").append("svg")
			    	.attr("width", width + margin.left + margin.right + 100)
			    	.attr("height", height + margin.top + margin.bottom + 100)
			  		.append("svg:g")
			    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				svg.append("g")
			    	.attr("class", "y axis")
			    	.attr("transform", "translate(50,0)")
			    	.call(yAxis);

				svg.append("g")
				    .attr("class", "x axis")
				    .attr("transform", "translate(50," + (height) + ")")
				    .call(xAxis);

				svg.append("g").selectAll("g")
				    .data(final_nest_array)
				  	.enter().append("g")
				  	.style("fill", function(d, i) { return z(i); })
				  	.attr("transform", function(d, i) { return "translate(" + (x1(i)) + ",0)"; })
				  	.selectAll("rect")
				    .data(function(d) { console.log(d); return d; })
				  	.enter().append("rect")
				    .attr("width", x1.rangeBand())
				    .attr("height", function(d){return height - y(d);})
				    .attr("x", function(d, i) { return x0(i)+50; })
				    .attr("y", function(d) { return y(d); });

				//http://stackoverflow.com/questions/11189284/d3-axis-labeling    
				svg.append("text")
					.attr("class", "x-label")
					.attr("text-anchor", "end")
					.attr("x", width-360)
					.attr("y", height + 60)
					.text("Survey Responses");

				svg.append("text")
					.attr("class", "y-label")
					.attr("text-anchor", "end")
					.attr("x", -270)
					.attr("y",-16)
					.attr("transform", "rotate(-90)")
					.text("Number of Students");
			}

			//BAR GRAPH WITH PERCENTAGES ASSOCIATED
			if (mode=="percent" && filter!=""){

				var final_percent_array = [];
				for (var tt=0;tt<tally.length;tt++){
					var percentage = 0.0;
					if (extra_tag[tt]!=undefined)
						percentage = (extra_tag[tt]/tally[tt])*100;
					else
						percentage = 0;
					console.log(percentage);
					final_percent_array.push(jQuery.parseJSON('{"filter":"'+filter_array2[tt]+'","count":'+percentage+'}'));
				}
				var margin = {top: 20, right: 30, bottom: 30, left: 40},
			    width = 800 - margin.left - margin.right,
			    height = 700 - margin.top - margin.bottom;
				var x = d3.scale.ordinal().domain(filter_array2).rangeRoundBands([0, width], .1);

				//var y = d3.scale.linear().domain([0, d3.max(bar_data_final2, function(d) { return d.count; })]).range([height, 0]);

				var y = d3.scale.linear().domain([0,100]).range([height, 0]);

				var xAxis = d3.svg.axis().scale(x).orient("bottom");

				//var yAxis = d3.svg.axis().scale(y).orient("left").ticks(d3.max(bar_data_final2, function(d) { return d.count; })/5);
				var yAxis = d3.svg.axis().scale(y).orient("left");

				if ($("svg").length){
					$("svg").remove();
				}
				var chart = d3.select("#graph").append("svg").attr("width", width + margin.left + margin.right + 100).attr("height", height + margin.top + margin.bottom + 100).append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				/*d3.csv("FakeSurveyData.csv", type, function(error, data) {
						x.domain(data.map(function(d) {
							return d.name; }));
						y.domain([0, d3.max(data, function(d) { return d.value; })]);*/

			  	chart.append("g").attr("class", "x axis").attr("transform", "translate(50," + height + ")").call(xAxis);

			 	chart.append("g").attr("class", "y axis").attr("transform","translate(50,0)").call(yAxis);

			  	chart.selectAll(".bar").data(final_percent_array).enter().append("rect").attr("class", "bar").attr("x", function(d) { return x(d.filter) + 50; }).attr("y", function(d) { return y(d.count); }).attr("height", function(d) {return height - y(d.count); }).attr("width", x.rangeBand());

			  	chart.selectAll(".total").data(totality).enter().append("text").attr("class", "total").attr("x", function(d) {return x(d.filter) + 50;}).attr("y", height-12).text(function(d) {return "Total:" + d.count; }).style("stroke","white").style("font-size",function(d){ if (d.count > 9) return 30; else return 33; }).style("font-family","fantasy");
			  	//x.rangeBand()

			  	chart.append("text")
					.attr("class", "x-label")
					.attr("text-anchor", "end")
					.attr("x", width-250)
					.attr("y", height + 60)
					.text("Survey Responses");

				chart.append("text")
					.attr("class", "y-label")
					.attr("text-anchor", "end")
					.attr("x", -270)
					.attr("y",-16)
					.attr("transform", "rotate(-90)")
					.text("Percentage");

				function type(d) {
			  		d.count = +d.count; // coerce to number
			  		return d;
				}
			}
		});
	});

</script>
